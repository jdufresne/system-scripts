- name: Install Ruby
  dnf:
    name:
      - ruby
      - ruby-devel
  become: yes

- name: Download chruby
  get_url:
    url: "https://github.com/postmodern/chruby/archive/v{{ chruby_version }}.tar.gz"
    dest: "{{ cache_dir }}/"
  register: chruby_download

- name: Extract chruby
  unarchive:
    src: "{{ chruby_download.dest }}"
    dest: "{{ cache_dir }}/"
    creates: "{{ cache_dir }}/chruby-{{ chruby_version }}"
  register: chruby_source

- name: Install chruby
  command:
    cmd: scripts/setup.sh
    chdir: "{{ cache_dir }}/chruby-{{ chruby_version }}"
  become: yes

- name: Download ruby-install
  get_url:
    url: "https://github.com/postmodern/ruby-install/archive/v{{ ruby_install_version }}.tar.gz"
    dest: "{{ cache_dir }}/"
  register: ruby_install_download

- name: Extract ruby-install
  unarchive:
    src: "{{ ruby_install_download.dest }}"
    dest: "{{ cache_dir }}/"
    creates: "{{ cache_dir }}/ruby-install-{{ ruby_install_version }}"
  register: ruby_install_source

- name: Install ruby-install
  make:
    chdir: "{{ cache_dir }}/ruby-install-{{ ruby_install_version }}"
    target: install
  become: yes

- name: Install Ruby versions
  command: "ruby-install --cleanup --no-install-deps --no-reinstall ruby {{ item }}"
  with_items: "{{ ruby_versions }}"

- name: Install bundler
  command: "chruby-exec {{ item }} -- gem install bundler"
  with_items: "{{ ruby_versions }}"
